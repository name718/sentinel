<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitor SDK - SourceMap æ¼”ç¤º</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-secondary: #64748b;
      --border: #e2e8f0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    .navbar {
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .nav-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo { display: flex; align-items: center; gap: 8px; }
    .logo-icon { font-size: 24px; }
    .logo-text { font-size: 20px; font-weight: 600; }
    .version {
      background: var(--primary);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
    }
    .nav-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg);
      border-radius: 20px;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-secondary);
    }
    .status-dot.active { background: var(--success); }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-content">
      <div class="logo">
        <span class="logo-icon">ğŸ—ºï¸</span>
        <span class="logo-text">SourceMap æ¼”ç¤º</span>
        <span class="version">v1.0.0</span>
      </div>
      <div class="nav-status">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">æœªè¿æ¥</span>
      </div>
    </div>
  </nav>
</body>
</html>

  <style>
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }
    .hero {
      text-align: center;
      padding: 40px 24px;
      background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
      color: white;
      border-radius: 16px;
      margin-bottom: 24px;
    }
    .hero h1 { font-size: 28px; margin-bottom: 8px; }
    .hero p { opacity: 0.9; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 24px;
      margin-bottom: 24px;
    }
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .card-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    .card-title { font-weight: 600; }
    .card-body { padding: 20px; }
    .btn-group { display: flex; flex-wrap: wrap; gap: 8px; }
    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-warning { background: var(--warning); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-outline { background: transparent; border: 1px solid var(--border); }
    .console {
      background: #1e293b;
      border-radius: 8px;
      padding: 16px;
      font-family: 'Monaco', monospace;
      font-size: 13px;
      color: #e2e8f0;
      max-height: 250px;
      overflow-y: auto;
    }
    .console-line { padding: 4px 0; border-bottom: 1px solid #334155; }
    .console-time { color: #64748b; margin-right: 8px; }
    .console-info { color: #60a5fa; }
    .console-success { color: #4ade80; }
    .console-error { color: #f87171; }
    .console-warn { color: #fbbf24; }
  </style>

  <style>
    .upload-area {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 24px;
      text-align: center;
      margin-bottom: 16px;
      transition: all 0.2s;
    }
    .upload-area:hover { border-color: var(--primary); background: #f8fafc; }
    .upload-area.dragover { border-color: var(--primary); background: #eef2ff; }
    .upload-icon { font-size: 32px; margin-bottom: 8px; }
    .upload-text { color: var(--text-secondary); font-size: 14px; }
    .file-input { display: none; }
    .file-list { margin-top: 12px; }
    .file-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg);
      border-radius: 6px;
      margin-bottom: 8px;
      font-size: 13px;
    }
    .file-name { flex: 1; }
    .file-size { color: var(--text-secondary); }
    .file-remove { cursor: pointer; color: var(--danger); }
    .parsed-stack {
      background: #1e293b;
      border-radius: 8px;
      padding: 16px;
      font-family: 'Monaco', monospace;
      font-size: 12px;
      color: #e2e8f0;
      max-height: 300px;
      overflow: auto;
    }
    .stack-frame {
      padding: 8px;
      border-bottom: 1px solid #334155;
    }
    .stack-frame:last-child { border-bottom: none; }
    .stack-original { color: #4ade80; }
    .stack-compiled { color: #64748b; font-size: 11px; }
    .stack-arrow { color: #fbbf24; margin: 0 8px; }
    .error-list { max-height: 200px; overflow-y: auto; }
    .error-item {
      padding: 12px;
      background: var(--bg);
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .error-item:hover { background: #eef2ff; }
    .error-item.selected { border: 2px solid var(--primary); }
    .error-type {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      background: #fef2f2;
      color: #dc2626;
      margin-right: 8px;
    }
    .error-msg { font-size: 13px; margin-top: 4px; color: var(--text-secondary); }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; }
    .form-group input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
    }
    .form-group input:focus { outline: none; border-color: var(--primary); }
  </style>

  <div class="container">
    <div class="hero">
      <h1>ğŸ—ºï¸ SourceMap è§£ææ¼”ç¤º</h1>
      <p>ä¸Šä¼  SourceMap æ–‡ä»¶ï¼Œè§¦å‘é”™è¯¯ï¼ŒæŸ¥çœ‹æºç ä½ç½®è¿˜åŸ</p>
    </div>

    <div class="grid">
      <!-- SDK åˆå§‹åŒ– -->
      <div class="card">
        <div class="card-header">
          <div class="card-icon" style="background: #f0f9ff;">âš™ï¸</div>
          <span class="card-title">1. åˆå§‹åŒ– SDK</span>
        </div>
        <div class="card-body">
          <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
            åˆå§‹åŒ–ç›‘æ§ SDKï¼Œå¼€å§‹æ•è·é”™è¯¯
          </p>
          <div class="btn-group">
            <button class="btn btn-primary" onclick="app.initSDK()">ğŸ”Œ åˆå§‹åŒ– SDK</button>
          </div>
        </div>
      </div>

      <!-- SourceMap ä¸Šä¼  -->
      <div class="card">
        <div class="card-header">
          <div class="card-icon" style="background: #f0fdf4;">ğŸ“</div>
          <span class="card-title">2. ä¸Šä¼  SourceMap</span>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label>ç‰ˆæœ¬å·</label>
            <input type="text" id="versionInput" value="1.0.0" placeholder="è¾“å…¥ç‰ˆæœ¬å·">
          </div>
          <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“¤</div>
            <div class="upload-text">æ‹–æ‹½ .map æ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ–ç‚¹å‡»é€‰æ‹©</div>
            <input type="file" class="file-input" id="fileInput" accept=".map" multiple>
          </div>
          <div class="file-list" id="fileList"></div>
          <button class="btn btn-success" onclick="uploadSourceMaps()">â¬†ï¸ ä¸Šä¼ åˆ°æœåŠ¡å™¨</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- é”™è¯¯è§¦å‘ -->
      <div class="card">
        <div class="card-header">
          <div class="card-icon" style="background: #fef2f2;">ğŸ›</div>
          <span class="card-title">3. è§¦å‘é”™è¯¯</span>
        </div>
        <div class="card-body">
          <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
            è§¦å‘å„ç§é”™è¯¯ï¼Œé”™è¯¯ä¼šè¢« SDK æ•è·å¹¶ä¸ŠæŠ¥
          </p>
          <div class="btn-group">
            <button class="btn btn-danger" onclick="app.testDivisionError()">â— é™¤é›¶é”™è¯¯</button>
            <button class="btn btn-warning" onclick="app.testUserDataError()">ğŸ‘¤ æ•°æ®æ ¡éªŒ</button>
            <button class="btn btn-outline" onclick="app.testNestedError()">ğŸ“š åµŒå¥—è°ƒç”¨</button>
            <button class="btn btn-outline" onclick="app.testUncaughtError()">ğŸ’¥ æœªæ•è·</button>
            <button class="btn btn-outline" onclick="app.testPromiseError()">âš¡ Promise</button>
            <button class="btn btn-outline" onclick="app.testAsyncError()">ğŸŒ å¼‚æ­¥é”™è¯¯</button>
          </div>
          <div style="margin-top: 16px;">
            <button class="btn btn-primary" onclick="app.flushData()">ğŸ“¤ ç«‹å³ä¸ŠæŠ¥</button>
            <button class="btn btn-outline" onclick="refreshErrors()">ğŸ”„ åˆ·æ–°é”™è¯¯åˆ—è¡¨</button>
          </div>
        </div>
      </div>

      <!-- é”™è¯¯åˆ—è¡¨ -->
      <div class="card">
        <div class="card-header">
          <div class="card-icon" style="background: #fefce8;">ğŸ“‹</div>
          <span class="card-title">4. é€‰æ‹©é”™è¯¯æŸ¥çœ‹è§£æ</span>
        </div>
        <div class="card-body">
          <div class="error-list" id="errorList">
            <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
              æš‚æ— é”™è¯¯è®°å½•
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SourceMap è§£æç»“æœ -->
    <div class="card" style="margin-bottom: 24px;">
      <div class="card-header">
        <div class="card-icon" style="background: #eff6ff;">ğŸ”</div>
        <span class="card-title">5. SourceMap è§£æç»“æœ</span>
      </div>
      <div class="card-body">
        <div id="parsedResult">
          <div style="text-align: center; color: var(--text-secondary); padding: 40px;">
            <div style="font-size: 48px; margin-bottom: 12px;">ğŸ—ºï¸</div>
            <p>é€‰æ‹©ä¸€ä¸ªé”™è¯¯æŸ¥çœ‹ SourceMap è§£æç»“æœ</p>
            <p style="font-size: 12px; margin-top: 8px;">å‹ç¼©åçš„å †æ ˆå°†è¢«è¿˜åŸä¸ºæºç ä½ç½®</p>
          </div>
        </div>
      </div>
    </div>

    <!-- æ§åˆ¶å° -->
    <div class="card">
      <div class="card-header">
        <div class="card-icon" style="background: #1e293b;">ğŸ’»</div>
        <span class="card-title">å®æ—¶æ—¥å¿—</span>
        <button class="btn btn-outline" style="margin-left: auto;" onclick="app.clearConsole()">æ¸…ç©º</button>
      </div>
      <div class="card-body">
        <div class="console" id="console"></div>
      </div>
    </div>
  </div>

  <script type="module" src="/src/main.ts"></script>
  
  <script>
    const SERVER_URL = 'http://localhost:3000';
    const DSN = 'demo-app';
    let selectedFiles = [];

    // æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');

    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    function handleFiles(files) {
      for (const file of files) {
        if (file.name.endsWith('.map')) {
          selectedFiles.push(file);
        }
      }
      renderFileList();
    }

    function renderFileList() {
      fileList.innerHTML = selectedFiles.map((file, index) => `
        <div class="file-item">
          <span>ğŸ“„</span>
          <span class="file-name">${file.name}</span>
          <span class="file-size">${(file.size / 1024).toFixed(1)} KB</span>
          <span class="file-remove" onclick="removeFile(${index})">âœ•</span>
        </div>
      `).join('');
    }

    function removeFile(index) {
      selectedFiles.splice(index, 1);
      renderFileList();
    }

    async function uploadSourceMaps() {
      if (selectedFiles.length === 0) {
        alert('è¯·å…ˆé€‰æ‹© SourceMap æ–‡ä»¶');
        return;
      }

      const version = document.getElementById('versionInput').value;
      if (!version) {
        alert('è¯·è¾“å…¥ç‰ˆæœ¬å·');
        return;
      }

      for (const file of selectedFiles) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('dsn', DSN);
        formData.append('version', version);

        try {
          const res = await fetch(`${SERVER_URL}/api/sourcemap`, {
            method: 'POST',
            body: formData
          });
          const data = await res.json();
          if (data.success) {
            console.log(`âœ… ${file.name} ä¸Šä¼ æˆåŠŸ`);
          } else {
            console.error(`âŒ ${file.name} ä¸Šä¼ å¤±è´¥:`, data.error);
          }
        } catch (e) {
          console.error(`âŒ ${file.name} ä¸Šä¼ å¤±è´¥:`, e);
        }
      }

      selectedFiles = [];
      renderFileList();
      alert('ä¸Šä¼ å®Œæˆï¼');
    }
  </script>

  <script>
    // åˆ·æ–°é”™è¯¯åˆ—è¡¨
    async function refreshErrors() {
      try {
        const res = await fetch(`${SERVER_URL}/api/errors?dsn=${DSN}&pageSize=10`);
        const data = await res.json();
        renderErrorList(data.list || []);
      } catch (e) {
        console.error('è·å–é”™è¯¯åˆ—è¡¨å¤±è´¥:', e);
      }
    }

    function renderErrorList(errors) {
      const container = document.getElementById('errorList');
      if (errors.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">æš‚æ— é”™è¯¯è®°å½•</div>';
        return;
      }

      container.innerHTML = errors.map(err => `
        <div class="error-item" onclick="selectError(${err.id})">
          <span class="error-type">${err.type}</span>
          <span style="font-size: 12px; color: var(--text-secondary);">#${err.id}</span>
          <div class="error-msg">${err.message.substring(0, 60)}${err.message.length > 60 ? '...' : ''}</div>
        </div>
      `).join('');
    }

    // é€‰æ‹©é”™è¯¯å¹¶è§£æ
    async function selectError(id) {
      const version = document.getElementById('versionInput').value;
      
      try {
        const res = await fetch(`${SERVER_URL}/api/errors/${id}?version=${version}`);
        const data = await res.json();
        renderParsedResult(data);
        
        // é«˜äº®é€‰ä¸­é¡¹
        document.querySelectorAll('.error-item').forEach(el => el.classList.remove('selected'));
        event.target.closest('.error-item')?.classList.add('selected');
      } catch (e) {
        console.error('è·å–é”™è¯¯è¯¦æƒ…å¤±è´¥:', e);
      }
    }

    function renderParsedResult(error) {
      const container = document.getElementById('parsedResult');
      
      let html = `
        <div style="margin-bottom: 16px;">
          <strong>é”™è¯¯ä¿¡æ¯:</strong> ${error.message}
        </div>
      `;

      if (error.stack) {
        html += `
          <div style="margin-bottom: 16px;">
            <strong>åŸå§‹å †æ ˆ:</strong>
            <pre style="background: #f1f5f9; padding: 12px; border-radius: 6px; font-size: 12px; overflow-x: auto; margin-top: 8px;">${error.stack}</pre>
          </div>
        `;
      }

      if (error.parsedStack && error.parsedStack.length > 0) {
        html += `
          <div>
            <strong>ğŸ—ºï¸ SourceMap è§£æç»“æœ:</strong>
            <div class="parsed-stack" style="margin-top: 8px;">
              ${error.parsedStack.map(frame => `
                <div class="stack-frame">
                  ${frame.originalFile ? `
                    <div class="stack-original">
                      ğŸ“ ${frame.originalFile}:${frame.originalLine}:${frame.originalColumn}
                      ${frame.originalName ? `<span style="color: #fbbf24;">(${frame.originalName})</span>` : ''}
                    </div>
                    <div class="stack-compiled">
                      â† ç¼–è¯‘å: ${frame.file}:${frame.line}:${frame.column}
                    </div>
                  ` : `
                    <div class="stack-compiled">
                      ${frame.file}:${frame.line}:${frame.column}
                      <span style="color: #64748b;">(æœªæ‰¾åˆ° SourceMap)</span>
                    </div>
                  `}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      } else {
        html += `
          <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
            <p>âš ï¸ æœªæ‰¾åˆ° SourceMap æˆ–å †æ ˆæ— æ³•è§£æ</p>
            <p style="font-size: 12px;">è¯·ç¡®ä¿å·²ä¸Šä¼ å¯¹åº”ç‰ˆæœ¬çš„ SourceMap æ–‡ä»¶</p>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    // é¡µé¢åŠ è½½ååˆ·æ–°é”™è¯¯åˆ—è¡¨
    setTimeout(refreshErrors, 1000);
  </script>
</body>
</html>