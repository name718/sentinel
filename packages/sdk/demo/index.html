<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitor SDK Demo</title>
  <style>
    body { font-family: system-ui; max-width: 800px; margin: 40px auto; padding: 0 20px; }
    button { margin: 5px; padding: 10px 20px; cursor: pointer; border-radius: 4px; border: 1px solid #ddd; }
    button:hover { background: #f0f0f0; }
    pre { background: #f5f5f5; padding: 15px; overflow: auto; border-radius: 4px; max-height: 300px; }
    h2 { margin-top: 30px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .success { color: green; }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>ğŸ” Monitor SDK Demo</h1>
  
  <h2>1. åˆå§‹åŒ–</h2>
  <button onclick="initSDK()">åˆå§‹åŒ– SDK</button>
  <button onclick="checkStatus()">æ£€æŸ¥çŠ¶æ€</button>
  
  <h2>2. é”™è¯¯æ•è·æµ‹è¯•</h2>
  <button onclick="triggerError()">è§¦å‘ JS é”™è¯¯</button>
  <button onclick="triggerPromiseError()">è§¦å‘ Promise é”™è¯¯</button>
  <button onclick="manualCapture()">æ‰‹åŠ¨æ•è·é”™è¯¯</button>
  
  <h2>3. èµ„æºåŠ è½½æµ‹è¯•</h2>
  <button onclick="loadBadScript()">åŠ è½½ä¸å­˜åœ¨çš„è„šæœ¬</button>
  <button onclick="loadBadImage()">åŠ è½½ä¸å­˜åœ¨çš„å›¾ç‰‡</button>
  
  <h2>4. ç”¨æˆ·è¡Œä¸ºè¿½è¸ª</h2>
  <button onclick="showBreadcrumbs()">æŸ¥çœ‹ Breadcrumbs</button>
  <button onclick="testFetch()">å‘èµ· Fetch è¯·æ±‚</button>
  <button onclick="testConsole()">æµ‹è¯• Console è®°å½•</button>
  
  <h2>5. æ•°æ®ä¸ŠæŠ¥</h2>
  <button onclick="flushData()">ç«‹å³ä¸ŠæŠ¥</button>
  <button onclick="queryErrors()">æŸ¥è¯¢é”™è¯¯åˆ—è¡¨</button>
  <button onclick="queryPerformance()">æŸ¥è¯¢æ€§èƒ½æ•°æ®</button>
  
  <h2>è¾“å‡º</h2>
  <pre id="output">ç­‰å¾…æ“ä½œ...</pre>

  <script src="../dist/index.js"></script>
  <script>
    const output = document.getElementById('output');
    const log = (msg, isError = false) => {
      const text = typeof msg === 'object' ? JSON.stringify(msg, null, 2) : msg;
      output.textContent = text;
      output.className = isError ? 'error' : '';
      console.log(msg);
    };

    // 1. åˆå§‹åŒ–
    function initSDK() {
      try {
        Monitor.Monitor.getInstance().init({
          dsn: 'demo-project',
          reportUrl: 'http://localhost:3000/api/report',
          maxBreadcrumbs: 10,
          batchSize: 5,
          reportInterval: 10000
        });
        log('âœ… SDK åˆå§‹åŒ–æˆåŠŸï¼');
      } catch (e) {
        log('âŒ åˆå§‹åŒ–å¤±è´¥: ' + e.message, true);
      }
    }

    function checkStatus() {
      const monitor = Monitor.Monitor.getInstance();
      log({
        initialized: monitor.isInitialized(),
        config: monitor.getConfig(),
        breadcrumbsCount: monitor.getBreadcrumbs().length
      });
    }

    // 2. é”™è¯¯æ•è·
    function triggerError() {
      log('è§¦å‘ JS é”™è¯¯...');
      setTimeout(() => {
        nonExistentFunction();
      }, 100);
    }

    function triggerPromiseError() {
      log('è§¦å‘ Promise é”™è¯¯...');
      Promise.reject(new Error('æµ‹è¯• Promise é”™è¯¯'));
    }

    function manualCapture() {
      Monitor.Monitor.getInstance().captureError(new Error('æ‰‹åŠ¨æ•è·çš„é”™è¯¯'));
      log('âœ… å·²æ‰‹åŠ¨æ•è·é”™è¯¯');
    }

    // 3. èµ„æºåŠ è½½
    function loadBadScript() {
      const script = document.createElement('script');
      script.src = 'http://localhost:9999/not-exist.js';
      document.body.appendChild(script);
      log('å°è¯•åŠ è½½ä¸å­˜åœ¨çš„è„šæœ¬...');
    }

    function loadBadImage() {
      const img = document.createElement('img');
      img.src = 'http://localhost:9999/not-exist.png';
      document.body.appendChild(img);
      log('å°è¯•åŠ è½½ä¸å­˜åœ¨çš„å›¾ç‰‡...');
    }

    // 4. ç”¨æˆ·è¡Œä¸º
    function showBreadcrumbs() {
      const breadcrumbs = Monitor.Monitor.getInstance().getBreadcrumbs();
      log(breadcrumbs);
    }

    async function testFetch() {
      try {
        const res = await fetch('http://localhost:3000/api/health');
        const data = await res.json();
        log({ message: 'Fetch æˆåŠŸ', data });
      } catch (e) {
        log('Fetch å¤±è´¥: ' + e.message, true);
      }
    }

    function testConsole() {
      console.log('è¿™æ˜¯ä¸€æ¡ log');
      console.warn('è¿™æ˜¯ä¸€æ¡ warning');
      console.error('è¿™æ˜¯ä¸€æ¡ error');
      log('âœ… å·²è¾“å‡º console.log/warn/errorï¼ŒæŸ¥çœ‹ Breadcrumbs');
    }

    // 5. æ•°æ®ä¸ŠæŠ¥
    function flushData() {
      Monitor.Monitor.getInstance().flush();
      log('âœ… å·²è§¦å‘ç«‹å³ä¸ŠæŠ¥');
    }

    async function queryErrors() {
      try {
        const res = await fetch('http://localhost:3000/api/errors?dsn=demo-project');
        const data = await res.json();
        log(data);
      } catch (e) {
        log('æŸ¥è¯¢å¤±è´¥: ' + e.message, true);
      }
    }

    async function queryPerformance() {
      try {
        const res = await fetch('http://localhost:3000/api/performance?dsn=demo-project');
        const data = await res.json();
        log(data);
      } catch (e) {
        log('æŸ¥è¯¢å¤±è´¥: ' + e.message, true);
      }
    }

    // ç›‘å¬å…¨å±€é”™è¯¯ç”¨äºæ˜¾ç¤º
    window.addEventListener('error', (e) => {
      log('æ•è·åˆ°é”™è¯¯: ' + e.message, true);
    });
    window.addEventListener('unhandledrejection', (e) => {
      log('æ•è·åˆ° Promise é”™è¯¯: ' + e.reason, true);
    });
  </script>
</body>
</html>
